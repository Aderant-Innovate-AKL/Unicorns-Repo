# The manifest for the "reconciliation-api" service.
# AI-Powered Name Reconciliation API using Amazon Bedrock and DynamoDB
# Read the full specification for the "Load Balanced Web Service" type at:
#  https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

name: reconciliation-api
type: Load Balanced Web Service

# Distribute traffic to your service.
http:
  path: '/'
  healthcheck:
    path: /health
    healthy_threshold: 3
    unhealthy_threshold: 2
    interval: 30s
    timeout: 10s

# Configuration for your containers and service.
image:
  build: lambda/name-reconciliation/Dockerfile
  port: 8080

cpu: 512 # Number of CPU units for the task.
memory: 1024 # Amount of memory in MiB used by the task.
count: 1 # Number of tasks that should be running in your service.
exec: true # Enable running commands in your container.

network:
  connect: true # Enable Service Connect for intra-environment traffic between services.

# IAM permissions for the task role
taskrole_policy:
  Version: '2012-10-17'
  Statement:
    - Effect: Allow
      Action:
        - bedrock:InvokeModel
      Resource:
        - arn:aws:bedrock:ap-southeast-2::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0
        - arn:aws:bedrock:ap-southeast-2::foundation-model/anthropic.claude-3-haiku-20240307-v1:0
        - arn:aws:bedrock:ap-southeast-2::foundation-model/anthropic.claude-3-5-sonnet-20240620-v1:0
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:Scan
        - dynamodb:Query
      Resource:
        - !GetAtt AddonsStack.Outputs.EntitiesTableArn
        - !Sub '${AddonsStack.Outputs.EntitiesTableArn}/index/*'

# Environment variables for the API
variables:
  BEDROCK_MODEL_ID: anthropic.claude-3-sonnet-20240229-v1:0
  AWS_REGION: ap-southeast-2

# Environment-specific overrides
environments:
  dev:
    variables:
      ENVIRONMENT: dev
      ENTITIES_TABLE_NAME: !GetAtt AddonsStack.Outputs.EntitiesTableName
    count: 1
